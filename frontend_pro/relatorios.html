<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Relat√≥rios (JSON)</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    :root{--bg:#0b1020;--card:#12182b;--muted:#9aa3b2;--txt:#e6ebf5}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,Segoe UI,Inter,Arial}
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#7c3aed,#22d3ee)}
    .title{font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #2a3250;background:#161d35;color:#e6ebf5;text-decoration:none;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.green{background:#0f2a1a;border-color:#1d7a47}
    .card{background:var(--card);border:1px solid #283052;border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .status{margin:12px 0;padding:10px 12px;border:1px solid #2a3250;border-radius:10px;background:#0e1427;color:#bfeaff}
    .status b{color:#fff}
    textarea.jsonbox{width:100%;min-height:360px;background:#0e1427;border:1px solid #283052;border-radius:10px;color:#e6ebf5;padding:12px;font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;resize:vertical}
    .row.right{justify-content:flex-end}
    .keywrap{display:flex;gap:8px;flex-wrap:wrap}
    .keywrap input{flex:1 1 320px;padding:10px 12px;border-radius:10px;border:1px solid #2a3250;background:#0e1427;color:#e6ebf5}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0e1427;border:1px solid #283052;border-radius:999px;padding:6px 10px;font-size:12px}
    .sep{height:1px;background:#283052;margin:14px 0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><div class="logo"></div><div class="title">Relat√≥rios</div></div>
      <a href="index.html" class="btn back">‚¨Ö In√≠cio</a>
    </div>

    <div id="status" class="status">üß© Pronto. Clique em <b>Atualizar JSON</b> para ver seus dados.</div>

    <div class="card">
      <div class="row">
        <span class="pill">Manter at√© 5 jogadas por jogo (armazenadas no navegador).</span>
        <span class="pill">Chaves: <b>history_gonogo</b>, <b>history_stroop</b>, <b>history_nback</b></span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnRefresh" class="btn">üîÑ Atualizar JSON</button>
        <button id="btnCopy" class="btn">üìã Copiar JSON</button>
        <button id="btnDownload" class="btn">üíæ Baixar JSON</button>
        <button id="btnClearAll" class="btn">üóë Limpar TUDO</button>
      </div>
      <div class="sep"></div>
      <textarea id="jsonBox" class="jsonbox" readonly>{"hint":"Clique em Atualizar JSON"}</textarea>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Analisar com IA (Gemini)</h3>
      <p class="muted">Cole sua <b>API Key do Gemini</b> (Google AI Studio). Ela ser√° salva apenas no seu navegador (localStorage) e usada nesta p√°gina.</p>
      <div class="keywrap">
        <input id="inpKey" type="password" placeholder="Cole aqui sua chave do Gemini (ex.: AIza...)" />
        <button id="btnSaveKey" class="btn">üîê Salvar chave</button>
        <button id="btnHideShow" class="btn">üëÅ Mostrar</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnAnalyze" class="btn green">ü§ñ Analisar JSON com Gemini</button>
      </div>
      <div class="sep"></div>
      <textarea id="aiOut" class="jsonbox" placeholder="Sa√≠da da IA aparecer√° aqui..."></textarea>
      <p class="muted">Modelo usado: <b>gemini-1.5-flash</b> (endpoint v1beta). Sem optional chaining para compatibilidade ampla.</p>
    </div>
  </div>

  <script>
    // ===== Constantes dos jogos =====
    var GAMES = [
      {key:'gonogo',  label:'Go/No-Go'},
      {key:'stroop',  label:'Stroop'},
      {key:'nback',   label:'N-Back 1'}
    ];

    // ===== Utils DOM =====
    function $(id){ return document.getElementById(id); }
    function setStatus(html){ $('status').innerHTML = html; }

    // ===== LocalStorage helpers =====
    function loadHist(key){
      var raw = localStorage.getItem('history_'+key);
      try { return raw ? JSON.parse(raw) : []; } catch(e){ return []; }
    }
    function clearAll(){
      for (var i=0;i<GAMES.length;i++){
        localStorage.removeItem('history_'+GAMES[i].key);
      }
    }

    // ===== Builder do JSON =====
    function buildJSON(){
      var out = {
        version: "1.0",
        generatedAt: new Date().toISOString(),
        games: {}
      };
      for (var i=0;i<GAMES.length;i++){
        var k = GAMES[i].key;
        out.games[k] = loadHist(k);
      }
      return out;
    }

    // ===== A√ß√µes JSON (UI) =====
    function refreshJSON(){
      var data = buildJSON();
      $('jsonBox').value = JSON.stringify(data, null, 2);
      setStatus('‚úÖ JSON atualizado com sucesso.');
    }
    function copyJSON(){
      try{
        var txt = $('jsonBox').value;
        navigator.clipboard.writeText(txt).then(function(){
          setStatus('üìã JSON copiado para a √°rea de transfer√™ncia.');
        }, function(){
          setStatus('‚ö† N√£o foi poss√≠vel copiar. Selecione e copie manualmente.');
        });
      }catch(e){
        setStatus('‚ö† Copia n√£o suportada. Selecione e copie manualmente.');
      }
    }
    function downloadJSON(){
      var data = $('jsonBox').value || JSON.stringify(buildJSON(), null, 2);
      var blob = new Blob([data], {type:'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = 'neuro_reports.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus('üíæ Download iniciado: neuro_reports.json');
    }

    // ===== Gemini Key (localStorage) =====
    var KEY_STORAGE = 'GEMINI_API_KEY';
    function saveKey(){
      var val = $('inpKey').value.trim();
      if (!val){ setStatus('‚ö† Cole uma chave v√°lida antes de salvar.'); return; }
      localStorage.setItem(KEY_STORAGE, val);
      setStatus('üîê Chave salva localmente (localStorage).');
    }
    function loadKeyToInput(){
      var k = localStorage.getItem(KEY_STORAGE);
      if (k){ $('inpKey').value = k; }
    }
    function toggleKeyVisibility(){
      var el = $('inpKey');
      if (el.type === 'password'){ el.type = 'text'; $('btnHideShow').textContent = 'üôà Ocultar'; }
      else { el.type = 'password'; $('btnHideShow').textContent = 'üëÅ Mostrar'; }
    }

    // ===== Chamada ao Gemini =====
    async function analyzeWithGemini(){
      var apiKey = localStorage.getItem(KEY_STORAGE);
      if (!apiKey){ setStatus('‚ùå Nenhuma chave do Gemini salva. Cole e clique em "Salvar chave".'); return; }

      // Garante JSON atualizado
      var payload = $('jsonBox').value;
      if (!payload || payload.trim() === '' || payload.indexOf('"games"') === -1){
        payload = JSON.stringify(buildJSON(), null, 2);
        $('jsonBox').value = payload;
      }

      var prompt = [
        "Voc√™ √© um analista cognitivo. Analise o seguinte JSON de sess√µes de jogos neurocognitivos.",
        "Explique com objetividade:",
        "- M√©tricas por jogo (acertos, erros, acur√°cia m√©dia).",
        "- Se h√° melhora/queda recente (√∫ltimas jogadas).",
        "- Recomenda√ß√µes pr√°ticas (dura√ß√£o, pausas, ajustes).",
        "",
        "JSON:\n"+payload
      ].join("\n");

      var body = {
        contents: [{
          role: "user",
          parts: [{ text: prompt }]
        }]
      };

      var url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key="+encodeURIComponent(apiKey);
      try{
        $('aiOut').value = "Processando com Gemini...";
        var res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok){
          var tx = await res.text();
          $('aiOut').value = "Erro HTTP "+res.status+": "+tx;
          setStatus('‚ùå Falha na chamada ao Gemini. Veja detalhes na sa√≠da.');
          return;
        }
        var data = await res.json();
        // Extrai texto (sem optional chaining p/ compatibilidade)
        var text = "";
        try {
          if (data && data.candidates && data.candidates.length>0 &&
              data.candidates[0].content && data.candidates[0].content.parts &&
              data.candidates[0].content.parts.length>0 &&
              data.candidates[0].content.parts[0].text){
            text = data.candidates[0].content.parts[0].text;
          } else {
            text = JSON.stringify(data, null, 2);
          }
        } catch(e){
          text = JSON.stringify(data, null, 2);
        }
        $('aiOut').value = text;
        setStatus('‚úÖ An√°lise conclu√≠da pelo Gemini.');
      }catch(err){
        console.error(err);
        $('aiOut').value = String(err);
        setStatus('‚ùå Erro de rede na chamada ao Gemini.');
      }
    }

    // ===== Inicializa√ß√£o =====
    window.addEventListener('DOMContentLoaded', function(){
      loadKeyToInput();
      $('btnRefresh').onclick  = refreshJSON;
      $('btnCopy').onclick     = copyJSON;
      $('btnDownload').onclick = downloadJSON;
      $('btnClearAll').onclick = function(){
        clearAll(); refreshJSON();
        setStatus('üóë Hist√≥rico apagado para todos os jogos.');
      };
      $('btnSaveKey').onclick  = saveKey;
      $('btnHideShow').onclick = toggleKeyVisibility;
      $('btnAnalyze').onclick  = function(){ analyzeWithGemini(); };
    });
  </script>
</body>
</html>