<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Relatórios (JSON • Análise local)</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    :root{--bg:#0b1020;--card:#12182b;--muted:#9aa3b2;--txt:#e6ebf5}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.45 system-ui,Segoe UI,Inter,Arial}
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#7c3aed,#22d3ee)}
    .title{font-weight:700}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #2a3250;background:#161d35;color:#e6ebf5;text-decoration:none;cursor:pointer}
    .btn.green{background:#0f2a1a;border-color:#1d7a47}
    .card{background:var(--card);border:1px solid #283052;border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .status{margin:12px 0;padding:10px 12px;border:1px solid #2a3250;border-radius:10px;background:#0e1427;color:#bfeaff}
    .status b{color:#fff}
    textarea.jsonbox{width:100%;min-height:320px;background:#0e1427;border:1px solid #283052;border-radius:10px;color:#e6ebf5;padding:12px;font:13px/1.5 ui-monospace,Consolas,Menlo,monospace;resize:vertical}
    .sep{height:1px;background:#283052;margin:14px 0}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><div class="logo"></div><div class="title">Relatórios</div></div>
      <a href="index.html" class="btn back">⬅ Início</a>
    </div>

    <div id="status" class="status">🧩 Pronto. Clique em <b>Atualizar JSON</b> para ver seus dados.</div>

    <div class="card">
      <div class="row">
        <span class="muted">Até 5 jogadas por jogo ficam salvas no seu navegador (chaves: <b>history_gonogo</b>, <b>history_stroop</b>, <b>history_nback</b>).</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnRefresh" class="btn">🔄 Atualizar JSON</button>
        <button id="btnCopy" class="btn">📋 Copiar JSON</button>
        <button id="btnDownload" class="btn">💾 Baixar JSON</button>
        <button id="btnClearAll" class="btn">🗑 Limpar TUDO</button>
      </div>
      <div class="sep"></div>
      <textarea id="jsonBox" class="jsonbox" readonly>{"hint":"Clique em Atualizar JSON"}</textarea>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Analisar localmente (sem chave, sem internet)</h3>
      <p class="muted">Gera um relatório inteligente no próprio navegador (médias, tendências, alertas e recomendações).</p>
      <div class="row">
        <button id="btnAnalyzeLocal" class="btn green">🤖 Analisar JSON (local)</button>
      </div>
      <div class="sep"></div>
      <textarea id="aiOut" class="jsonbox" placeholder="A análise aparecerá aqui..."></textarea>
    </div>
  </div>

  <script>
    // ===== Jogos / storage =====
    var GAMES = [{key:'gonogo',label:'Go/No-Go'},{key:'stroop',label:'Stroop'},{key:'nback',label:'N-Back 1'}];
    function $(id){ return document.getElementById(id); }
    function setStatus(html){ $('status').innerHTML = html; }
    function loadHist(key){ var raw = localStorage.getItem('history_'+key); try { return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
    function clearAll(){ for (var i=0;i<GAMES.length;i++){ localStorage.removeItem('history_'+GAMES[i].key); } }

    // ===== Monta JSON =====
    function buildJSON(){
      var out = { version:"1.0", generatedAt:new Date().toISOString(), games:{} };
      for (var i=0;i<GAMES.length;i++){ out.games[GAMES[i].key] = loadHist(GAMES[i].key); }
      return out;
    }

    // ===== UI JSON =====
    function refreshJSON(){
      $('jsonBox').value = JSON.stringify(buildJSON(), null, 2);
      setStatus('✅ JSON atualizado.');
    }
    function copyJSON(){
      var txt = $('jsonBox').value || JSON.stringify(buildJSON(), null, 2);
      navigator.clipboard.writeText(txt).then(function(){ setStatus('📋 JSON copiado.'); },
        function(){ setStatus('⚠ Copie manualmente (permissão de clipboard?).'); });
    }
    function downloadJSON(){
      var data = $('jsonBox').value || JSON.stringify(buildJSON(), null, 2);
      var blob = new Blob([data], {type:'application/json'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a'); a.href=url; a.download='neuro_reports.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus('💾 Baixado: neuro_reports.json');
    }

    // ===== “IA” local (sem API) =====
    function mean(arr){ if(!arr.length) return 0; var s=0; for(var i=0;i<arr.length;i++) s+=arr[i]; return s/arr.length; }
    function trend(arr){ // retorna ↑ ↓ → comparando média últimas 3 vs anteriores
      if(arr.length<2) return '→';
      var k=Math.min(3,arr.length); 
      var recent=arr.slice(-k); var prev=arr.slice(0,arr.length-k);
      if(prev.length===0) return '→';
      var mR=mean(recent), mP=mean(prev);
      var diff=mR-mP, rel=Math.abs(diff)/Math.max(1,mP);
      if(diff>0 && rel>0.05) return '↑'; // +5%
      if(diff<0 && rel>0.05) return '↓';
      return '→';
    }
    function safePct(x){ return (Math.round(x*10)/10).toFixed(1) + '%'; }

    function analyzeLocally(){
      // garante JSON
      var raw = $('jsonBox').value;
      if(!raw || raw.indexOf('"games"')===-1){ raw = JSON.stringify(buildJSON(), null, 2); $('jsonBox').value = raw; }
      var data; try{ data = JSON.parse(raw); }catch(e){ $('aiOut').value = 'JSON inválido.'; return; }

      var lines = [];
      lines.push('🧠 Relatório (análise local, sem IA na nuvem)');
      lines.push('Gerado em: '+new Date().toLocaleString());
      lines.push('');

      function blockForGame(key, label){
        var arr = (data.games && data.games[key]) ? data.games[key] : [];
        lines.push('## '+label);
        if(!arr.length){ lines.push('Sem jogadas registradas.'); lines.push(''); return; }

        // ordenar por ts ascendente
        arr = arr.slice().sort(function(a,b){ return a.ts - b.ts; });

        // métricas por sessão
        var accs = arr.map(function(s){ return (s.hits / Math.max(1,s.trials)) * 100; });
        var errs = arr.map(function(s){ return s.errors || 0; });
        var hits = arr.map(function(s){ return s.hits || 0; });

        var accMean = mean(accs);
        var errMean = mean(errs);
        var hitMean = mean(hits);

        var tAcc = trend(accs);
        var tErr = trend(errs.map(function(x){return -x;})); // menos erros = melhor
        var tHit = trend(hits);

        lines.push('Jogadas analisadas: '+arr.length);
        lines.push('Acurácia média: '+safePct(accMean));
        lines.push('Erros médios: '+(Math.round(errMean*10)/10));
        lines.push('Acertos médios: '+(Math.round(hitMean*10)/10));
        lines.push('Tendências — Acurácia: '+tAcc+' | Erros: '+tErr+' | Acertos: '+tHit);

        // alertas simples
        var last = arr[arr.length-1];
        var lastAcc = (last.hits/Math.max(1,last.trials))*100;
        var alertas = [];
        if(lastAcc < 60) alertas.push('queda de desempenho na última sessão (<60% de acurácia)');
        if(errMean > (last.trials*0.4)) alertas.push('muitos erros em média');
        if(arr.length>=5 && tAcc==='↓') alertas.push('tendência de queda nas últimas sessões');

        if(alertas.length){
          lines.push('⚠ Alertas: '+alertas.join(' · '));
        } else {
          lines.push('✅ Sem alertas relevantes.');
        }

        // recomendações heurísticas
        var recs = [];
        // duração ideal (baseada em 20 trials padrão do Go/No-Go)
        if(accMean < 70) recs.push('fazer sessões mais curtas e frequentes (ex.: 2×10 min)');
        else recs.push('manter volume atual com pausas curtas (2–3 min a cada 10–15 min)');
        if(tAcc==='↓') recs.push('reduzir distrações e aumentar intervalo entre blocos');
        if(tErr==='↓') recs.push('progredir gradualmente a dificuldade');
        if(recs.length) lines.push('💡 Recomendações: '+recs.join(' · '));

        lines.push('');
      }

      blockForGame('gonogo','Go/No-Go');
      blockForGame('stroop','Stroop');
      blockForGame('nback','N-Back 1');

      $('aiOut').value = lines.join('\n');
      setStatus('✅ Análise local pronta.');
    }

    // ===== init =====
    window.addEventListener('DOMContentLoaded', function(){
      $('btnRefresh').onclick  = refreshJSON;
      $('btnCopy').onclick     = copyJSON;
      $('btnDownload').onclick = downloadJSON;
      $('btnClearAll').onclick = function(){ clearAll(); refreshJSON(); setStatus('🗑 Histórico limpo.'); };
      $('btnAnalyzeLocal').onclick = analyzeLocally;
    });
  </script>
</body>
</html>