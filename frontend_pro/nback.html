<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>N-back 1</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script defer>
  /* ===== Utils ===== */
  const $ = (id)=>document.getElementById(id);
  function pushHistory(gameKey, sess){
    const key = 'history_'+gameKey;
    let arr = [];
    try { arr = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ arr = []; }
    arr.push(sess);
    if (arr.length > 5) arr = arr.slice(arr.length - 5);
    localStorage.setItem(key, JSON.stringify(arr));
  }

  /* ===== Config ===== */
  const SYMS   = ['▲','■','●','★'];
  const PAL    = ['#dc2626','#2563eb','#16a34a','#f59e0b','#111827'];
  const TRIALS = 20;
  const TRIAL_MS = 2000;
  const GAP_MS   = 200;

  /* ===== Estado ===== */
  let last = null;
  let trial = 0, hits = 0, errors = 0;
  let countdownId = null, trialEndsAt = 0;
  let running = false, lockInputs = false;
  let currentShown = null, currentIsMatch = false;

  const setBtnsEnabled = (on)=>{
    $('btnIgual').disabled = !on;
    $('btnDif').disabled   = !on;
  };

  function startN(){
    if (running) return;
    running = true;
    trial = 0; hits = 0; errors = 0; last = null;
    $('feedback').textContent = '';
    $('trial').textContent = '0';
    $('hits').textContent = '0';
    $('err').textContent = '0';
    $('sym').textContent = '';
    setBtnsEnabled(true);
    next();
  }

  function next(){
    if (countdownId) { clearInterval(countdownId); countdownId = null; }
    lockInputs = true;

    trial++;
    if (trial > TRIALS){ finish(); return; }

    const candidate = SYMS[Math.floor(Math.random()*SYMS.length)];
    const tryMatch = (last !== null && Math.random() < 0.30);
    const shown = tryMatch ? last : candidate;

    // cor aleatória cada trial
    const color = PAL[Math.floor(Math.random()*PAL.length)];
    const symEl = $('sym');
    symEl.style.color = color;
    symEl.textContent = shown;

    currentShown = shown;
    currentIsMatch = (shown === last);

    $('trial').textContent = String(trial);
    $('hits').textContent  = String(hits);
    $('err').textContent   = String(errors);

    lockInputs = false;
    trialEndsAt = performance.now() + TRIAL_MS;
    countdownId = setInterval(()=>{
      const left = Math.max(0, trialEndsAt - performance.now());
      $('timerN').textContent = (left/1000).toFixed(1)+'s';
      if (left <= 0){
        clearInterval(countdownId); countdownId = null;
        lockInputs = true;
        errors++; flash('err');
        last = shown;
        setTimeout(next, GAP_MS);
      }
    }, 50);

    $('btnIgual').onclick = ()=>pick('igual');
    $('btnDif').onclick   = ()=>pick('dif');
  }

  function pick(ans){
    if (!running || lockInputs) return;
    if (!countdownId) return;
    clearInterval(countdownId); countdownId = null;
    lockInputs = true;

    const ok = (ans==='igual' && currentIsMatch) || (ans==='dif' && !currentIsMatch);
    if (ok){ hits++; flash('ok'); } else { errors++; flash('err'); }
    last = currentShown;
    setTimeout(next, GAP_MS);
  }

  function finish(){
    running = false;
    setBtnsEnabled(false);
    $('timerN').textContent = '0.0s';
    $('feedback').className = 'feedback ok';
    $('feedback').textContent = `✅ Fim! Acertos: ${hits} | Erros: ${errors}`;

    pushHistory('nback', {
      ts: Date.now(),
      trials: TRIALS,
      hits: hits,
      errors: errors,
      accuracy: (hits / TRIALS) * 100
    });
  }

  function flash(type){
    const fb = $('feedback');
    fb.className = 'feedback ' + (type==='ok' ? 'ok' : 'err');
    fb.textContent = (type==='ok' ? '✔ Correto' : '✖ Errado');
  }

  // atalhos de teclado
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !running) { startN(); }
    if (!running) return;
    if (e.key === 'j' || e.key === 'J') { $('btnIgual').click(); }
    if (e.key === 'f' || e.key === 'F') { $('btnDif').click(); }
  });

  window.addEventListener('DOMContentLoaded', ()=>{
    setBtnsEnabled(false);
    $('btnStart').onclick = startN;
  });
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><div class="logo"></div><div class="title">N-back 1</div></div>
      <a href="jogos.html" class="btn back">⬅ Jogos</a>
    </div>

    <div class="card game-wrap center">
      <div class="hud">
        <span class="badge">Trial: <b id="trial">0</b> / 20</span>
        <span class="badge">Acertos: <b id="hits">0</b></span>
        <span class="badge">Erros: <b id="err">0</b></span>
        <span class="badge">Tempo: <b id="timerN">0.0s</b></span>
      </div>

      <div class="stage"><div id="sym" class="symbol"></div></div>
      <div class="feedback" id="feedback"></div>

      <div class="controls">
        <button id="btnStart" class="btn green">▶ Iniciar</button>
        <button id="btnIgual" class="btn primary">IGUAL (J)</button>
        <button id="btnDif" class="btn secondary">DIFERENTE (F)</button>
      </div>
      <p class="muted">Responda se o símbolo atual é igual ao imediatamente anterior.</p>
    </div>
  </div>
</body>
</html>